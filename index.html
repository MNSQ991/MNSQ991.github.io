<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ğŸ è´ªåƒè›‡ Â· å¸¦æ‘„åƒå¤´ç›‘æ§</title>
  <meta name="description" content="è´ªåƒè›‡æ¸¸æˆ + è¿œç¨‹æ‘„åƒå¤´æŸ¥çœ‹">

  <!-- PWA è®¾ç½® -->
  <meta name="theme-color" content="#111">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Cloudflare Web Analytics -->
  <script defer src='https://static.cloudflareinsights.com/beacon.min.js'
          data-cf-beacon='{"token": "ce8176d5e3c44c9a8b20d9f0e5d6a7b8"}'></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f0f0f0;
      text-align: center;
      padding: 10px;
      color: #333;
    }
    h1 { color: #0074D9; margin: 15px 0; }
    h2 { font-size: 1.2em; margin: 10px 0; color: #555; }

    #game-container {
      margin: 15px auto;
      position: relative;
      width: min(95vw, 400px);
      height: min(95vw, 400px);
      border: 8px solid #333;
      background: #111;
      border-radius: 8px;
      overflow: hidden;
    }
    .snake { position: absolute; width: 20px; height: 20px; background: #0f0; border-radius: 4px; }
    .snake:first-child { background: #0f8; box-shadow: 0 0 6px rgba(0,255,128,0.8); }
    .food { position: absolute; width: 20px; height: 20px; background: red; border-radius: 50%; box-shadow: 0 0 8px yellow; }

    #score { font-size: 18px; margin: 10px; }

    .controls {
      display: grid;
      grid-template-rows: repeat(3, 1fr);
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      width: 180px;
      height: 180px;
      margin: 20px auto;
    }
    .ctrl-btn {
      background: #0074D9; color: white; border: none; border-radius: 8px; font-size: 24px; cursor: pointer;
    }
    .ctrl-btn:active { background: #0056a3; }
    .ctrl-empty { visibility: hidden; }

    button {
      padding: 10px 20px; font-size: 16px; background: #0074D9; color: white; border: none; border-radius: 5px; margin: 5px; cursor: pointer;
    }

    .stats {
      margin: 15px auto;
      padding: 10px;
      background: #fff;
      border-radius: 8px;
      font-size: 0.95em;
      text-align: left;
      max-width: 400px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* æ‘„åƒå¤´æ¨¡å— */
    #camera-section {
      margin: 20px auto;
      max-width: 400px;
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    #camera-input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
    }
    #camera-feed {
      width: 100%;
      max-height: 300px;
      margin-top: 10px;
      border-radius: 5px;
      display: none;
    }

    .footer {
      margin-top: 30px;
      color: #666;
      font-size: 0.9em;
    }
    .footer a {
      color: #0074D9;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>ğŸ® è´ªåƒè›‡ Â· å¸¦æ‘„åƒå¤´ç›‘æ§</h1>
  <h2>æ¬¢è¿æ¥è‡ª ğŸŒ çš„ç©å®¶ï¼</h2>
  <div id="score">å¾—åˆ†ï¼š0 | ğŸ† æœ€é«˜ï¼š0</div>
  <div id="game-container"></div>

  <!-- è™šæ‹Ÿæ–¹å‘é”® -->
  <div class="controls">
    <div class="ctrl-empty"></div>
    <button class="ctrl-btn" onclick="setDir('up')">â¬†ï¸</button>
    <div class="ctrl-empty"></div>
    <button class="ctrl-btn" onclick="setDir('left')">â¬…ï¸</button>
    <div class="ctrl-empty"></div>
    <button class="ctrl-btn" onclick="setDir('right')">â¡ï¸</button>
    <div class="ctrl-empty"></div>
    <button class="ctrl-btn" onclick="setDir('down')">â¬‡ï¸</button>
    <div class="ctrl-empty"></div>
  </div>

  <button onclick="startGame()">â–¶ï¸ å¼€å§‹æ¸¸æˆ</button>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <div class="stats">
    <p><strong>ğŸ“Š æœ¬åœ°ç»Ÿè®¡</strong></p>
    <p>ğŸ® æœ¬æœºæ¸¸æˆæ¬¡æ•°ï¼š<span id="playCount">0</span></p>
    <p>â±ï¸ æœ€é•¿å•æ¬¡åœ¨çº¿ï¼š<span id="longestTime">0ç§’</span></p>
    <p>ğŸ“ æµè§ˆå™¨åœ°åŒºï¼šç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«ä¸­...ï¼ˆä¾èµ– Cloudflareï¼‰</p>
  </div>

  <!-- æ‘„åƒå¤´æŸ¥çœ‹å™¨ -->
  <div id="camera-section">
    <h3>ğŸ“¹ æŸ¥çœ‹æ‘„åƒå¤´</h3>
    <p>è¾“å…¥æ‘„åƒå¤´åœ°å€ï¼ˆå¦‚ http://192.168.1.100:8080/videoï¼‰</p>
    <input type="text" id="camera-input" placeholder="è¯·è¾“å…¥æ‘„åƒå¤´è§†é¢‘æµåœ°å€ï¼ˆHTTP/RTSPï¼‰" />
    <button onclick="connectCamera()">ğŸ”— è¿æ¥æ‘„åƒå¤´</button>
    <image id="camera-feed" alt="æ‘„åƒå¤´ç”»é¢" />
  </div>

  <div class="footer">
    <a href="blog.html">â¬…ï¸ å›åšå®¢ä¸»é¡µ</a> | å¯æ·»åŠ åˆ°ä¸»å±å¹•ç¦»çº¿æ¸¸ç©ï¼
  </div>

  <script>
    // ========== è´ªåƒè›‡æ¸¸æˆé€»è¾‘ï¼ˆåŸæ ·ä¿ç•™ï¼‰==========
    const container = document.getElementById("game-container");
    const scoreDisplay = document.getElementById("score");
    const width = 400;
    const cellSize = 20;
    const cols = width / cellSize;
    const rows = width / cellSize;

    let snake = [];
    let food = {};
    let direction = "right";
    let nextDirection = "right";
    let score = 0;
    let gameInterval;
    let gameRunning = false;
    let gameStartTime = 0;
    let playCount = parseInt(localStorage.getItem('snakePlayCount') || '0');
    let longestTime = parseInt(localStorage.getItem('snakeLongestTime') || '0');
    let highScore = parseInt(localStorage.getItem('snakeHighScore') || '0');

    function updateScore() {
      scoreDisplay.textContent = `å¾—åˆ†ï¼š${score} | ğŸ† æœ€é«˜ï¼š${highScore}`;
      document.getElementById('playCount').textContent = playCount;
      document.getElementById('longestTime').textContent = formatTime(longestTime);
    }

    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      return `${min}åˆ†${sec}ç§’`;
    }

    function initGame() {
      container.innerHTML = "";
      snake = [{ x: 10, y: 10 }];
      direction = "right";
      nextDirection = "right";
      score = 0;
      gameRunning = true;
      gameStartTime = Date.now();
      createFood();
      drawSnake();
      updateScore();
    }

    function drawSnake() {
      document.querySelectorAll(".snake, .food").forEach(el => el.remove());

      snake.forEach((part, index) => {
        const el = document.createElement("div");
        el.className = "snake";
        el.style.left = part.x * cellSize + "px";
        el.style.top = part.y * cellSize + "px";
        container.appendChild(el);
      });

      const foodEl = document.createElement("div");
      foodEl.className = "food";
      foodEl.style.left = food.x * cellSize + "px";
      foodEl.style.top = food.y * cellSize + "px";
      container.appendChild(foodEl);
    }

    function createFood() {
      food = {
        x: Math.floor(Math.random() * cols),
        y: Math.floor(Math.random() * rows)
      };
      if (snake.some(part => part.x === food.x && part.y === food.y)) {
        return createFood();
      }
    }

    function moveSnake() {
      direction = nextDirection;
      const head = { ...snake[0] };

      switch (direction) {
        case "up": head.y--; break;
        case "down": head.y++; break;
        case "left": head.x--; break;
        case "right": head.x++; break;
      }

      if (head.x < 0 || head.x >= cols || head.y < 0 || head.y >= rows) {
        gameOver();
        return;
      }

      if (snake.some((part, i) => i > 0 && part.x === head.x && part.y === head.y)) {
        gameOver();
        return;
      }

      snake.unshift(head);

      if (head.x === food.x && head.y === food.y) {
        score += 10;
        updateScore();
        createFood();
      } else {
        snake.pop();
      }

      drawSnake();
    }

    function gameOver() {
      clearInterval(gameInterval);
      gameRunning = false;

      const duration = Math.floor((Date.now() - gameStartTime) / 1000);
      playCount++;
      localStorage.setItem('snakePlayCount', playCount);

      if (duration > longestTime) {
        longestTime = duration;
        localStorage.setItem('snakeLongestTime', longestTime);
      }

      if (score > highScore) {
        highScore = score;
        localStorage.setItem('snakeHighScore', highScore);
      }

      updateScore();
      alert(`æ¸¸æˆç»“æŸï¼æœ¬æ¬¡æ—¶é•¿ï¼š${formatTime(duration)}ï¼Œå¾—åˆ†ï¼š${score}`);
    }

    function startGame() {
      if (gameRunning) return;
      initGame();
      clearInterval(gameInterval);
      gameInterval = setInterval(moveSnake, 150);
    }

    window.setDir = (dir) => {
      const opp = { up: 'down', down: 'up', left: 'right', right: 'left' };
      if (direction !== opp[dir]) nextDirection = dir;
    };

    document.addEventListener("keydown", (e) => {
      switch (e.key) {
        case "ArrowUp": if (direction !== "down") nextDirection = "up"; e.preventDefault(); break;
        case "ArrowDown": if (direction !== "up") nextDirection = "down"; e.preventDefault(); break;
        case "ArrowLeft": if (direction !== "right") nextDirection = "left"; e.preventDefault(); break;
        case "ArrowRight": if (direction !== "left") nextDirection = "right"; e.preventDefault(); break;
      }
    });

    updateScore();

    // ========== æ‘„åƒå¤´æŸ¥çœ‹å™¨æ¨¡å— ==========
    const cameraInput = document.getElementById('camera-input');
    const cameraFeed = document.getElementById('camera-feed');

    function connectCamera() {
      const url = cameraInput.value.trim();
      if (!url) {
        alert('è¯·è¾“å…¥æ‘„åƒå¤´åœ°å€ï¼');
        return;
      }

      // å°è¯•åŠ è½½å›¾ç‰‡æµï¼ˆé€‚ç”¨äº MJPEG æˆ–é™æ€å¿«ç…§ï¼‰
      cameraFeed.src = url;
      cameraFeed.style.display = 'block';
      cameraFeed.onload = () => {
        alert('âœ… å·²è¿æ¥æ‘„åƒå¤´ï¼ç”»é¢æ­£åœ¨åŠ è½½...');
      };
      cameraFeed.onerror = () => {
        alert('âŒ æ— æ³•è¿æ¥æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥åœ°å€æ˜¯å¦æ­£ç¡®ã€‚\nå¸¸è§é—®é¢˜ï¼šè·¨åŸŸã€åè®®ä¸æ”¯æŒã€æ‘„åƒå¤´æœªå¼€å¯ã€‚');
        cameraFeed.style.display = 'none';
      };
    }

    // Service Workerï¼ˆç¦»çº¿æ”¯æŒï¼‰
    const swScript = `
      self.addEventListener('install', e => {
        e.waitUntil(caches.open('snake-v3').then(cache => cache.addAll(['/'])));
      });
      self.addEventListener('fetch', e => {
        e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
      });
    `;
    if ('serviceWorker' in navigator) {
      const blob = new Blob([swScript], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(blob);
      window.addEventListener('load', () => {
        navigator.serviceWorker.register(swUrl);
      });
    }

    // åˆå§‹æç¤º
    setTimeout(() => {
      alert("ğŸ® æ¬¢è¿æ¥åˆ°è´ªåƒè›‡å¤§å…ï¼\nä½¿ç”¨æ–¹å‘é”®æˆ–è™šæ‹ŸæŒ‰é”®æ§åˆ¶\nä¸‹æ–¹å¯è¿æ¥æ‘„åƒå¤´æŸ¥çœ‹å®æ—¶ç”»é¢ï¼");
    }, 600);
  </script>
</body>
</html>
