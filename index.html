<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ğŸ è´ªåƒè›‡ Â· ç©å®¶å¤§å…</title>
  <meta name="description" content="å¸¦è®¿é—®ç»Ÿè®¡ã€åœ°åŒºè¯†åˆ«ã€åœ¨çº¿æ—¶é•¿å’Œæ’è¡Œæ¦œçš„è´ªåƒè›‡æ¸¸æˆ">

  <!-- PWA è®¾ç½® -->
  <meta name="theme-color" content="#111">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- å†…è” manifest.json -->
  <script type="application/ld+json">
  {
    "name": "è´ªåƒè›‡æ¸¸æˆ",
    "short_name": "è´ªåƒè›‡",
    "description": "å¸¦æ’è¡Œæ¦œå’Œç»Ÿè®¡çš„è´ªåƒè›‡",
    "start_url": "/",
    "display": "standalone",
    "background_color": "#111",
    "theme_color": "#0074D9",
    "icons": [
      {
        "src": "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%23111'/><text x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='120' fill='%230f0'>ğŸ</text></svg>",
        "sizes": "192x192",
        "type": "image/svg+xml"
      }
    ]
  }
  </script>

  <!-- Cloudflare Web Analytics -->
  <script defer src='https://static.cloudflareinsights.com/beacon.min.js'
          data-cf-beacon='{"token": "ce8176d5e3c44c9a8b20d9f0e5d6a7b8"}'></script>
  <!-- âš ï¸ æç¤ºï¼šå»ºè®®æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ tokenï¼ˆå…è´¹æ³¨å†Œ Cloudflare åè·å–ï¼‰ -->

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f0f0f0;
      text-align: center;
      padding: 10px;
      color: #333;
    }
    h1 { color: #0074D9; margin: 15px 0; }
    h2 { font-size: 1.2em; margin: 10px 0; color: #555; }

    #game-container {
      margin: 15px auto;
      position: relative;
      width: min(95vw, 400px);
      height: min(95vw, 400px);
      border: 8px solid #333;
      background: #111;
      border-radius: 8px;
      overflow: hidden;
    }
    .snake { position: absolute; width: 20px; height: 20px; background: #0f0; border-radius: 4px; }
    .snake:first-child { background: #0f8; box-shadow: 0 0 6px rgba(0,255,128,0.8); }
    .food { position: absolute; width: 20px; height: 20px; background: red; border-radius: 50%; box-shadow: 0 0 8px yellow; }

    #score { font-size: 18px; margin: 10px; }

    .controls {
      display: grid;
      grid-template-rows: repeat(3, 1fr);
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      width: 180px;
      height: 180px;
      margin: 20px auto;
    }
    .ctrl-btn {
      background: #0074D9; color: white; border: none; border-radius: 8px; font-size: 24px; cursor: pointer;
    }
    .ctrl-btn:active { background: #0056a3; }
    .ctrl-empty { visibility: hidden; }

    button {
      padding: 10px 20px; font-size: 16px; background: #0074D9; color: white; border: none; border-radius: 5px; margin: 5px; cursor: pointer;
    }

    .stats {
      margin: 15px;
      padding: 10px;
      background: #fff;
      border-radius: 8px;
      font-size: 0.95em;
      text-align: left;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .leaderboard {
      margin: 20px auto;
      max-width: 400px;
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .leaderboard h3 { color: #333; }
    .leaderboard ol { text-align: left; margin-left: 20px; }

    .footer {
      margin-top: 30px;
      color: #666;
      font-size: 0.9em;
    }
    .footer a {
      color: #0074D9;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>ğŸ® è´ªåƒè›‡ Â· ç©å®¶å¤§å…</h1>
  <h2>æ¬¢è¿æ¥è‡ª ğŸŒ çš„ç©å®¶ï¼</h2>
  <div id="score">å¾—åˆ†ï¼š0 | ğŸ† æœ€é«˜ï¼š0</div>
  <div id="game-container"></div>

  <!-- è™šæ‹Ÿæ–¹å‘é”® -->
  <div class="controls">
    <div class="ctrl-empty"></div>
    <button class="ctrl-btn" onclick="setDir('up')">â¬†ï¸</button>
    <div class="ctrl-empty"></div>
    <button class="ctrl-btn" onclick="setDir('left')">â¬…ï¸</button>
    <div class="ctrl-empty"></div>
    <button class="ctrl-btn" onclick="setDir('right')">â¡ï¸</button>
    <div class="ctrl-empty"></div>
    <button class="ctrl-btn" onclick="setDir('down')">â¬‡ï¸</button>
    <div class="ctrl-empty"></div>
  </div>

  <button onclick="startGame()">â–¶ï¸ å¼€å§‹æ¸¸æˆ</button>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <div class="stats">
    <p><strong>ğŸ“Š æœ¬åœ°ç»Ÿè®¡</strong></p>
    <p>ğŸ® æœ¬æœºæ¸¸æˆæ¬¡æ•°ï¼š<span id="playCount">0</span></p>
    <p>â±ï¸ æœ€é•¿å•æ¬¡åœ¨çº¿ï¼š<span id="longestTime">0ç§’</span></p>
    <p>ğŸ“ æµè§ˆå™¨åœ°åŒºï¼šç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«ä¸­...ï¼ˆä¾èµ– Cloudflareï¼‰</p>
  </div>

  <!-- æ’è¡Œæ¦œ -->
  <div class="leaderboard">
    <h3>ğŸ† æœ¬åœ°æ’è¡Œæ¦œï¼ˆæœ¬æœºè®°å½•ï¼‰</h3>
    <ol id="rankList"></ol>
  </div>

  <div class="footer">
    <a href="blog.html">â¬…ï¸ å›åšå®¢ä¸»é¡µ</a> | å¯æ·»åŠ åˆ°ä¸»å±å¹•ç¦»çº¿æ¸¸ç©ï¼
  </div>

  <script>
    // æ¸¸æˆé…ç½®
    const container = document.getElementById("game-container");
    const scoreDisplay = document.getElementById("score");
    const width = 400;
    const cellSize = 20;
    const cols = width / cellSize;
    const rows = width / cellSize;

    let snake = [];
    let food = {};
    let direction = "right";
    let nextDirection = "right";
    let score = 0;
    let gameInterval;
    let gameRunning = false;
    let gameStartTime = 0;
    let playCount = parseInt(localStorage.getItem('snakePlayCount') || '0');
    let longestTime = parseInt(localStorage.getItem('snakeLongestTime') || '0'); // ç§’
    let highScore = parseInt(localStorage.getItem('snakeHighScore') || '0');
    let leaderboard = JSON.parse(localStorage.getItem('snakeLeaderboard') || '[]');

    // æ›´æ–°æ˜¾ç¤º
    function updateScore() {
      scoreDisplay.textContent = `å¾—åˆ†ï¼š${score} | ğŸ† æœ€é«˜ï¼š${highScore}`;
      document.getElementById('playCount').textContent = playCount;
      document.getElementById('longestTime').textContent = formatTime(longestTime);
    }

    // æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’ â†’ mm:ssï¼‰
    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      return `${min}åˆ†${sec}ç§’`;
    }

    function initGame() {
      container.innerHTML = "";
      snake = [{ x: 10, y: 10 }];
      direction = "right";
      nextDirection = "right";
      score = 0;
      gameRunning = true;
      gameStartTime = Date.now();
      createFood();
      drawSnake();
      updateScore();
    }

    function drawSnake() {
      document.querySelectorAll(".snake, .food").forEach(el => el.remove());

      snake.forEach((part, index) => {
        const el = document.createElement("div");
        el.className = "snake";
        el.style.left = part.x * cellSize + "px";
        el.style.top = part.y * cellSize + "px";
        container.appendChild(el);
      });

      const foodEl = document.createElement("div");
      foodEl.className = "food";
      foodEl.style.left = food.x * cellSize + "px";
      foodEl.style.top = food.y * cellSize + "px";
      container.appendChild(foodEl);
    }

    function createFood() {
      food = {
        x: Math.floor(Math.random() * cols),
        y: Math.floor(Math.random() * rows)
      };
      if (snake.some(part => part.x === food.x && part.y === food.y)) {
        return createFood();
      }
    }

    function moveSnake() {
      direction = nextDirection;
      const head = { ...snake[0] };

      switch (direction) {
        case "up": head.y--; break;
        case "down": head.y++; break;
        case "left": head.x--; break;
        case "right": head.x++; break;
      }

      // æ’å¢™
      if (head.x < 0 || head.x >= cols || head.y < 0 || head.y >= rows) {
        gameOver();
        return;
      }

      // æ’è‡ªå·±
      if (snake.some((part, i) => i > 0 && part.x === head.x && part.y === head.y)) {
        gameOver();
        return;
      }

      snake.unshift(head);

      if (head.x === food.x && head.y === food.y) {
        score += 10;
        updateScore();
        createFood();
      } else {
        snake.pop();
      }

      drawSnake();
    }

    function gameOver() {
      clearInterval(gameInterval);
      gameRunning = false;

      const duration = Math.floor((Date.now() - gameStartTime) / 1000);
      playCount++;
      localStorage.setItem('snakePlayCount', playCount);

      if (duration > longestTime) {
        longestTime = duration;
        localStorage.setItem('snakeLongestTime', longestTime);
      }

      if (score > highScore) {
        highScore = score;
        localStorage.setItem('snakeHighScore', highScore);
      }

      // åŠ å…¥æ’è¡Œæ¦œ
      const playerName = prompt(`æ¸¸æˆç»“æŸï¼ä½ å¾—äº† ${score} åˆ†ï¼\nè¯·è¾“å…¥æ˜µç§°ï¼ˆå¯ç•™ç©ºï¼‰ï¼š`, 'ç©å®¶') || 'åŒ¿å';
      leaderboard.push({ name: playerName, score, time: new Date().toLocaleString() });
      leaderboard.sort((a, b) => b.score - a.score);
      leaderboard = leaderboard.slice(0, 10); // åªä¿ç•™å‰10
      localStorage.setItem('snakeLeaderboard', JSON.stringify(leaderboard));

      updateScore();
      renderLeaderboard();

      alert(`æ¸¸æˆç»“æŸï¼æœ¬æ¬¡æ—¶é•¿ï¼š${formatTime(duration)}ï¼Œå¾—åˆ†ï¼š${score}`);
    }

    function renderLeaderboard() {
      const list = document.getElementById('rankList');
      list.innerHTML = '';
      leaderboard.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.name} - ${item.score}åˆ† (${item.time})`;
        list.appendChild(li);
      });
    }

    function startGame() {
      if (gameRunning) return;
      initGame();
      clearInterval(gameInterval);
      gameInterval = setInterval(moveSnake, 150);
    }

    // è®¾ç½®æ–¹å‘
    window.setDir = (dir) => {
      const opp = { up: 'down', down: 'up', left: 'right', right: 'left' };
      if (direction !== opp[dir]) nextDirection = dir;
    };

    // é”®ç›˜æ§åˆ¶
    document.addEventListener("keydown", (e) => {
      switch (e.key) {
        case "ArrowUp": if (direction !== "down") nextDirection = "up"; e.preventDefault(); break;
        case "ArrowDown": if (direction !== "up") nextDirection = "down"; e.preventDefault(); break;
        case "ArrowLeft": if (direction !== "right") nextDirection = "left"; e.preventDefault(); break;
        case "ArrowRight": if (direction !== "left") nextDirection = "right"; e.preventDefault(); break;
      }
    });

    // åˆå§‹åŒ–æ’è¡Œæ¦œ
    renderLeaderboard();
    updateScore();

    // Service Workerï¼ˆç¦»çº¿æ”¯æŒï¼‰
    const swScript = `
      self.addEventListener('install', e => {
        e.waitUntil(caches.open('snake-v2').then(cache => cache.addAll(['/'])));
      });
      self.addEventListener('fetch', e => {
        e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
      });
    `;
    if ('serviceWorker' in navigator) {
      const blob = new Blob([swScript], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(blob);
      window.addEventListener('load', () => {
        navigator.serviceWorker.register(swUrl);
      });
    }

    // åˆå§‹æç¤º
    setTimeout(() => {
      alert("ğŸ® æ¬¢è¿æ¥åˆ°è´ªåƒè›‡å¤§å…ï¼\nä½¿ç”¨æ–¹å‘é”®æˆ–è™šæ‹ŸæŒ‰é”®æ§åˆ¶\næ¸¸æˆç»“æŸåå¯å½•å…¥æ˜µç§°è¿›å…¥æ’è¡Œæ¦œï¼");
    }, 600);
  </script>
</body>
</html>
